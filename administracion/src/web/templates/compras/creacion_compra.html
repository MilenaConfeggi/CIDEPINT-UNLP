{% extends 'layout.html' %}
{% block title %}Nueva compra{% endblock %}
{% block content %}
    <form id="upload-form" class="px-4" method="POST" enctype="multipart/form-data" action="{{ url_for('compra.agregando_compra') }}">
        {{ form.hidden_tag() }}
        <div class="space-y-12">
        <div class="border-b border-gray-900/10 pb-12">
            <h2 class="text-base/7 font-semibold text-gray-900">Nueva compra</h2>
            <p class="mt-1 text-sm/6 text-gray-600">Ingrese la información de la nueva compra</p>
            <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                <div class="sm:col-span-4">
                    <label for="fecha" class="block text-sm/6 font-medium text-gray-900">Fecha</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.fecha(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6', placeholder='Ingrese fecha') }}
                        </div>
                    </div>
                </div>               
                <div class="sm:col-span-4">
                    <label for="descripcion" class="block text-sm/6 font-medium text-gray-900">Descripcion</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.descripcion(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6', placeholder='Ingrese descripcion') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="proveedor" class="block text-sm/6 font-medium text-gray-900">Proveedor</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.proveedor(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="solicitante" class="block text-sm/6 font-medium text-gray-900">Solicitante</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.solicitante(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="importe" class="block text-sm/6 font-medium text-gray-900">Importe</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.importe(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6', placeholder='Ingrese importe') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="observaciones" class="block text-sm/6 font-medium text-gray-900">Observaciones</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.observaciones(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6', placeholder='Ingrese observaciones') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="estado" class="block text-sm/6 font-medium text-gray-900">Estado</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.estado(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6', id='estado') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4">
                    <label for="numero_factura" class="block text-sm/6 font-medium text-gray-900">Numero de factura</label>
                    <div class="mt-2">
                        <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-indigo-600 sm:max-w-md">
                            {{ form.numero_factura(class='form-control block flex-1 border-0 bg-transparent py-1.5 pl-1 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm/6', placeholder='Ingrese numero de factura') }}
                        </div>
                    </div>
                </div>
                <div class="sm:col-span-4" id="fuentes-financiamiento-container" style="display: none;">
                    <label for="fuentes_financiamiento" class="block text-sm/6 font-medium text-gray-900">Fuentes de Financiamiento</label>
                        <!-- Lista dinámica para asignar fondos -->
                        <div id="fondos-list">
                            <h3 class="block text-sm/15 font-medium text-gray-900">Asignar fondos</h3>

                        </div>
                        
                        <!-- Botón para agregar un nuevo usuario a la lista -->
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" onclick="addFondo()">Agregar fondo</button>
                        <!-- Lista dinámica para asignar empleados -->
                        <div id="empleados-list">
                            <h3 class="block text-sm/15 font-medium text-gray-900">Asignar empleados</h3>

                        </div>
                        
                        <!-- Botón para agregar un nuevo usuario a la lista -->
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" onclick="addEmpleado()">Agregar empleado</button>
                        <!-- Lista dinámica para asignar areas -->
                        <div id="areas-list">
                            <h3 class="block text-sm/15 font-medium text-gray-900">Asignar areas</h3>

                        </div>
                        
                        <!-- Botón para agregar un nuevo usuario a la lista -->
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" onclick="addArea()">Agregar area</button>

                </div>
            </div>
        </div>
        <div class="mt-6 flex items-center justify-end gap-x-6">
            <a href="{{ url_for('compra.lista_compras') }}" type="button" class="text-sm/6 font-semibold text-gray-900">Cancelar</a>
            <button type="submit" class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600">Guardar cambios</button>
        </div>
    </form>
    <script>
        document.getElementById('importe').addEventListener('input', function() {
            var estadoField = document.getElementById('estado');
            if (this.value.trim() !== '') {
                estadoField.disabled = false;
            } else {
                estadoField.disabled = true;
                estadoField.selectedIndex = 0; // Reset to the first option
                document.getElementById('fuentes-financiamiento-container').style.display = 'none';
            }
        });

        document.getElementById('estado').addEventListener('change', function() {
            var fuentesContainer = document.getElementById('fuentes-financiamiento-container');
            if (this.value === 'APROBADA' || this.value === 'REALIZADA') {
                fuentesContainer.style.display = 'block';
            } else {
                fuentesContainer.style.display = 'none';
            }
        });

        function addFondo() {
            const fondosList = document.getElementById("fondos-list");
            const fondoCount = fondosList.children.length; // Índice basado en la cantidad actual de permisos
    
            // Crear un nuevo div para el permiso
            const newFondoDiv = document.createElement("div");
            newFondoDiv.className = "fondo-item";
    
            newFondoDiv.innerHTML = `
            <div class="my-2">
                <label for="fondos-${fondoCount}-titulo_fondo">Fondo:</label>
                <select name="fondos-${fondoCount}-titulo_fondo" id="fondos-${fondoCount}-titulo_fondo" class="form-control w-full sm:w-auto">
                    {% for fondo in fondos %}
                        <option value="{{ fondo.titulo }}">{{ fondo.titulo }}</option>
                    {% endfor %}
                </select>
    
                <label for="fondos-${fondoCount}-monto">Monto:</label>
                <input type="number" step="0.01" name="fondos-${fondoCount}-monto" id="fondos-${fondoCount}-monto" class="form-control w-full sm:w-auto" placeholder="Ingrese monto">
    
                <button type="button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600" onclick="removeFondo(this)">Eliminar</button>
            </div>
            `;
    
            fondosList.appendChild(newFondoDiv);
            }
    
            function removeFondo(button) {
                const fondoItem = button.closest(".fondo-item");
                fondoItem.remove();
            } 

        function addEmpleado() {
            const empleadosList = document.getElementById("empleados-list");
            const empleadoCount = empleadosList.children.length;

            const newEmpleadoDiv = document.createElement("div");
            newEmpleadoDiv.className = "empleado-item";

            newEmpleadoDiv.innerHTML = `
            <div class="my-2">
                <label for="empleados-${empleadoCount}-id_empleado">Empleado:</label>
                <select name="empleados-${empleadoCount}-id_empleado" id="empleados-${empleadoCount}-id_empleado" class="form-control w-full sm:w-auto">
                    {% for empleado in empleados %}
                        <option value="{{ empleado.id }}">{{ empleado.nombre }} {{ empleado.apellido }} - {{ empleado.dni }}</option>
                    {% endfor %}
                </select>

                <label for="empleados-${empleadoCount}-monto">Monto:</label>
                <input type="number" step="0.01" name="empleados-${empleadoCount}-monto" id="empleados-${empleadoCount}-monto" class="form-control w-full sm:w-auto" placeholder="Ingrese monto">

                <button type="button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600" onclick="removeEmpleado(this)">Eliminar</button>
            </div>
            `;

            empleadosList.appendChild(newEmpleadoDiv);
        }

        function removeEmpleado(button) {
            const empleadoItem = button.closest(".empleado-item");
            empleadoItem.remove();
        }

        function addArea() {
            const areasList = document.getElementById("areas-list");
            const areaCount = areasList.children.length;

            const newAreaDiv = document.createElement("div");
            newAreaDiv.className = "area-item";

            newAreaDiv.innerHTML = `
            <div class="my-2">
                <label for="areas-${areaCount}-id_area">Area:</label>
                <select name="areas-${areaCount}-id_area" id="areas-${areaCount}-id_area" class="form-control w-full sm:w-auto">
                    {% for area in areas %}
                        <option value="{{ area.id }}">{{ area.nombre }}</option>
                    {% endfor %}
                </select>

                <label for="areas-${areaCount}-monto">Monto:</label>
                <input type="number" step="0.01" name="areas-${areaCount}-monto" id="areas-${areaCount}-monto" class="form-control w-full sm:w-auto" placeholder="Ingrese monto">


                <button type="button" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600" onclick="removeArea(this)">Eliminar</button>
            </div>
            `;

            areasList.appendChild(newAreaDiv);
        }

        function removeArea(button) {
            const areaItem = button.closest(".area-item");
            areaItem.remove();
        }
    </script>
{% endblock %}